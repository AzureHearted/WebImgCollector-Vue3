<template><el-dropdown-item :icon="Management" @click="info.open = true">规则管理器<teleport to=".onlineGallery-container" v-if="info.open"><el-dialogv-model="info.open"title="规则管理器"width="80%":before-close="handleClose"top="10vh"draggablelock-scroll><el-container><el-asidewidth="200px":current-node-key="info.showRuleId"show-checkboxhighlight-current><el-tree-v2 :data="treeData" :props="treeProps" :height="208"><template #default="{node}"><div v-if="node.key != '#'" style="display: flex"><span class="ruleName">{{ node.label }}</span><spanstyle="display: flex"class="icon-button"@mouseenter="info.button.delete.isHover = true"@mouseleave="info.button.delete.isHover = false"><el-icon class="icon-button-deleteRule" @click="deleteRule(node)"><component v-if="!info.button.delete.isHover" :is="Delete" /><component v-if="info.button.delete.isHover" :is="DeleteFilled" /></el-icon></span></div><div v-if="node.key == '#'"><el-buttontype="primary"size="small":icon="CirclePlusFilled"@click="createRule">{{ node.label }}</el-button></div></template></el-tree-v2></el-aside><el-main><el-tabsv-model="info.form.activeName"type="card"@tab-click=""v-if="info.form.realTimeData != null"><el-tab-pane label="首选项" name="main"><el-form :model="info.form.realTimeData.main" label-width="100px"><el-form-item label="规则名称"><el-input v-model="info.form.realTimeData.main.name" /></el-form-item><el-form-item label="根网址"><el-input v-model="info.form.realTimeData.main.domainName" /></el-form-item><el-form-item label="路径过滤器"><el-input v-model="info.form.realTimeData.main.pathFilter" /></el-form-item></el-form></el-tab-pane><el-tab-pane label="链接(必填)" name="linkUrl"><el-form :model="info.form.realTimeData.linkUrl" label-width="100px"><el-form-item label="css选择器"><el-input v-model="info.form.realTimeData.linkUrl.selector" type="textarea" /></el-form-item><el-form-item label="提取类型"><el-selectv-model="info.form.realTimeData.linkUrl.infoType"placeholder="选择要提取的类型"><el-option :value="1" label="值" /><el-option :value="2" label="Attribute属性" /><el-option :value="3" label="Property属性" /><el-option :value="4" label="innerText 内部文本" /><el-option :value="5" label="innerHTML 内部HTML" /><el-option :value="6" label="outerHTML 全部HTML" /></el-select></el-form-item><el-form-item label="属性名"><el-input v-model="info.form.realTimeData.linkUrl.attribute" type="textarea" /></el-form-item></el-form></el-tab-pane><el-tab-pane label="图链" name="picUrl"> 图链 </el-tab-pane><el-tab-pane label="名称" name="name"> 名称 </el-tab-pane><el-tab-pane label="元信息" name="meta"> 元信息 </el-tab-pane></el-tabs></el-main></el-container><template #footer><span class="dialog-footer"><el-button @click="handleClose">取消</el-button><el-button type="primary" @click="save">保存</el-button></span></template></el-dialog></teleport></el-dropdown-item></template><script setup>import {ElMessage} from "element-plus";import {Rule, buildUUID} from "../js/public.js";import {Management, CirclePlusFilled, Delete, DeleteFilled} from "@element-plus/icons-vue"; const info = reactive({open: false,showRuleId: "#",form: {activeName: "main",realTimeData: null,editing: [], },button: {delete: {isHover: false,},},});const data = reactive({ruleList: [],});const treeProps = reactive({value: "id",label: "label",children: "children",disabled: "disabled",});const inputFormData = async (ruleData = null) => {if (ruleData != null) {info.form.realTimeData = JSON.parse(JSON.stringify(ruleData));} else {info.form.realTimeData = null;}};const treeData = computed(() => {let result = data.ruleList.map((rule) => {return {id: rule.main.id,label: rule.main.name,children: [],disabled: false,};});result.push({id: "#",label: "创建规则",children: [],disabled: false,icon: CirclePlusFilled,});return result;});const createRule = async () => {let rule = new Rule(); data.ruleList.push(rule); info.showRuleId = rule.main.id;inputFormData(rule);};const deleteRule = async (node) => {ElMessageBox.confirm(`确认删除规则 ${node.label} ？(此操作无法恢复)`, null, {confirmButtonText: "确认",cancelButtonText: "取消",}).then(() => {const ruleName = node.label;const index = data.ruleList.findIndex((item) => item.id === node.key);data.ruleList.splice(index, 1);inputFormData();ElMessage({type: "success",grouping: true,center: true,duration: 1000,offset: 80,message: `规则 ${ruleName} 删除成功!`,});}).catch(() => {});};const handleClose = async () => {ElMessageBox.confirm("确认关闭？", null, {confirmButtonText: "确认",cancelButtonText: "取消",}).then(() => {info.open = false;initDialog();}).catch(() => {});};const initDialog = () => {info.form.activeName = "main";info.form.realTimeData = null;};const save = async () => {GM_setValue("ruleList", JSON.stringify(data.ruleList));info.open = false;};watch(() => info.open,(newVal, oldVal) => {if (newVal) {initDialog();let localRuleList = GM_getValue("ruleList");if (localRuleList != null) {data.ruleList = JSON.parse(localRuleList);console.log("数据已导入", data);} else {data.ruleList = [];console.log("本地数据为空 -> 初始化数据", data);}}});</script><style lang="scss" scoped>.icon-button-deleteRule {color: red;}</style>