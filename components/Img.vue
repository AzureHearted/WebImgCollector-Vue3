<template> <div> <img :style="imgStyle" :parentSelector="parentSelector" v-lazy.src="src" v-if="lazy" @load="imgLoad" /> <img :style="imgStyle" :src="src" v-else @load="imgLoad" /> </div></template><script lang="ts" setup> interface IProps { parentSelector?: string; src: string; lazy: boolean; lazyMargin?: string; imgStyle?: string; } const props = withDefaults(defineProps<IProps>(), { src: "", parentSelector: "body", lazy: false, lazyMargin(props) { return "0%"; }, }); const emits = defineEmits(["load"]); const realSize = reactive({ width: 0, height: 0, }); function imgLoad(payload: Event) { const img = payload.target as HTMLImageElement; const {naturalWidth, naturalHeight} = img; if (naturalWidth > 0 && naturalHeight > 0) { realSize.width = naturalWidth; realSize.height = naturalHeight; } } watch( () => realSize, (newVal, oldVal) => { if (newVal.width > oldVal.width && newVal.height > oldVal.height) { emits("load", newVal); } else { emits("load", oldVal); } }, {deep: true} ); const vLazy = { mounted(el: HTMLImageElement, binding, vNode) { el.src = ""; el.dataset.show = "false"; let url = binding.value; let observer = new IntersectionObserver( (entries, observer) => { entries.forEach((entire) => { if (entire.isIntersecting) { observer.unobserve(el); el.src = url; if (el.tagName == "IMG") { if (el.complete) { el.dataset.show = "true"; } else { el.addEventListener("load", fn); el.addEventListener("error", fn); function fn() { el.dataset.show = "true"; el.removeEventListener("load", fn); el.removeEventListener("error", fn); } } } else { el.dataset.show = "true"; } } }); }, { root: document.querySelector(props.parentSelector), rootMargin: props.lazyMargin, } ); observer.observe(el); }, };</script><style lang="scss" scoped> * { margin: 0 !important; padding: 0 !important; border: 0 !important; box-sizing: border-box !important; z-index: 0 !important; } img { width: 100%; height: 100%; } [data-show="true"] { opacity: 1; filter: blur(0px); transition: 0.2s; } [data-show="false"] { opacity: 0; filter: blur(10px); transition: 0.2s; }</style>