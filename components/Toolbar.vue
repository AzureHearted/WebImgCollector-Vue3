<template><div class="onlineGallery-toolBar"><el-statistic class="statistic" :value="cardsStore.data.filterCards.length"><template #title><div style="display: flex; justify-content: center">选中 / 可见 / 总数</div></template><template #prefix>{{ selectedCards.length }} / </template><template #suffix>/ {{ cardsStore.data.cardList.length }} </template></el-statistic><div class="filter"><div class="size"><div class="width row"><span class="label">宽度</span><el-slider:debounce="500"class="slider"label="宽度"v-model="filter.size.width.value"range:min="0":max="filter.size.width.max"placement="right" /></div><div class="height row"><span class="label">高度</span><el-slider:debounce="500"class="slider"label="高度"v-model="filter.size.height.value"range:min="0":max="filter.size.height.max"placement="right" /></div></div><div class="format"><span class="label">格式</span><el-select-v2class="select"v-model="filter.formats.value"filterableclearableallow-createcollapse-tagscollapse-tags-tooltip:max-collapse-tags="1":options="filter.formats.options"placeholder="格式过滤"multiple></el-select-v2></div></div><div class="zoom-slider"><span>最大显示行数</span><el-sliderlabel="最大显示行数"v-model="listStore.info.nowColumn":min="1":max="6":step="1"placement="right"show-stops /></div><el-button-group class="button-group"><el-buttontype="primary"@click="refresh":loading="loading.value">刷新<template #icon><el-icon><i-ep-RefreshRight /></el-icon></template></el-button><el-buttontype="primary"@click="allSelectSwitch":loading="loading.value":icon="listStore.info.allSelected ? CheckboxAll : CheckboxNone">{{ listStore.info.allSelected ? "全选" : "取消全选" }}</el-button><el-buttontype="primary"@click="downloadSelected":loading="loading.value">下载选中<template #icon><el-icon><i-ep-Download /></el-icon></template></el-button></el-button-group><el-dropdown ><el-button type="primary" ><template #icon><el-icon><i-ep-MoreFilled /></el-icon></template></el-button><template #dropdown><el-dropdown-menu><el-dropdown-item @click="ruleEditor.container.open = true"><el-icon><i-ep-Management /></el-icon>规则管理</el-dropdown-item><el-dropdown-item @click=""><el-icon><i-ep-Tools /></el-icon>设置</el-dropdown-item></el-dropdown-menu></template></el-dropdown></div></template><script setup lang="ts">import CheckboxNone from "/src/svg/checkbox-blank-line.svg"; import CheckboxAll from "/src/svg/checkbox-fill.svg"; const appInfo = useAppInfoStore(); const cardsStore = useCardsStore(); const Toolbar = useToolBarStore(); const listStore = useListInfoStore();const ruleEditor = useRuleEditorStore(); const loading = appInfo.loading;const filter = Toolbar.filter;const refresh = async () => {await getCards();};const selectedCards = computed(() => {return cardsStore.data.cardList.filter((card) => card.selected);});const allSelectSwitch = async () => {listStore.info.allSelected = !listStore.info.allSelected; appInfo.loading.value = true;cardsStore.data.filterCards.forEach((card) => (card.selected = listStore.info.allSelected));appInfo.loading.value = false;};const downloadSelected = async () => {const downloadCards = selectedCards.value;if (!downloadCards.length) {ElMessage({message: "请选择要下载的数据",type: "info",showClose: true,grouping: true,offset: 80,});return;}const taskQueue = new TaskQueue({showMessage: false, max: 5});loading.init();let finallyCount = 0;for (const card of downloadCards) {if (card.blob == null) {const task = async () => {const url = card.url;let blob = await getBlobByUrl(url, "Fetch");if (!blob) {blob = await getBlobByUrl(url, "GM");}if (!blob) {blob = await getBlobByUrl(url, "GM", location.origin);}card.blob = blob;if (card.blob != null) {return [card.name, "处理成功!"];} else {return [card.name, "处理失败"];}};taskQueue.addTask(task);}}taskQueue.singleCallback = () => {finallyCount++;loading.percentage = (finallyCount / downloadCards.length) * 100;};taskQueue.finallyCallback = async () => {ElMessage({message: "下载成功! (正在生成压缩包)",type: "success",showClose: true,grouping: true,offset: 80,});const zipContainer = new JSZip();for (const card of downloadCards) {if (card.name != null && card.blob != null) {zipContainer.file(card.name, card.blob);}}const zip = await zipContainer.generateAsync({type: "blob",compression: "DEFLATE",level: 9,});let zipName: string = document.querySelector<any>("title").innerText;saveAs(zip, `${zipName}.zip`);loading.percentage = 100;loading.reset();};taskQueue.run();};const getCards = async () => {let cardDomList = await getImgOrVideoDom(); let tempCardList: matchCard[] = [];if (!cardDomList.length) {ElMessage({message: "没有匹配到相应数据",type: "info",showClose: true,grouping: true,offset: 80,});return;}const taskQueue = new TaskQueue({showMessage: false, max: 10});loading.init();let finallyCount = 0;taskQueue.taskList = cardDomList.map((dom, index) => {return async () => {const card: matchCard = {name: "",url: "",originUrls: [],meta: <metaInterFace>{isOk: false,width: 0,height: 0,aspectRatio: 3 / 4,},match: false, selected: false, dom: dom,};if (dom.tagName == "META") {card.originUrls = <string[]>([getTagInfo(dom, 3, "content")].filter((url) => !isEmpty(url, true)));if (card.originUrls.length > 0) {card.url = card.originUrls[0];const blob = await fetch(card.url).then((res) => res.blob()).catch(() => {return new Blob(undefined, {type: "none"});});if (/^image/.test(blob.type)) {const meta: metaInterFace = await getMetaByBlob(blob);if (meta.isOk) {card.name = getNameByUrl(card.url);card.meta.width = meta.width;card.meta.height = meta.height;card.meta.aspectRatio = meta.width / meta.height;card.match = true;}}}} else if (dom.tagName == "IMG" || dom.tagName == "VIDEO") {if (dom.naturalWidth > 0 && dom.naturalHeight > 0) {card.originUrls = <string[]>([getTagInfo(dom, 2, "srcset"),getTagInfo(dom, 2, "data-src"),getTagInfo(dom, 3, "src"),].filter((url) => !isEmpty(url, true)));if (card.originUrls.length > 0) {card.url = card.originUrls[0];card.name = getNameByUrl(card.url);card.meta.width = dom.naturalWidth;card.meta.height = dom.naturalHeight;card.meta.aspectRatio = dom.naturalWidth / dom.naturalHeight;card.match = true;}} else {card.originUrls = <any>([getTagInfo(dom, 2, "srcset"),getTagInfo(dom, 2, "data-src"),getTagInfo(dom, 3, "src"),].filter((url) => !isEmpty(url, true)));if (card.originUrls.length > 0) {card.url = card.originUrls[0];const blob = await fetch(card.url).then((res) => res.blob()).catch((err) => {return new Blob(undefined, {type: "none"});});if (/^image/.test(blob.type)) {const meta: metaInterFace = await getMetaByBlob(blob);if (meta.isOk) {card.name = getNameByUrl(card.url);card.meta.width = meta.width;card.meta.height = meta.height;card.meta.aspectRatio = meta.width / meta.height;card.match = true;}}}}} else if (dom.tagName == "A") {card.originUrls = <string[]>([getTagInfo(dom, 3, "href")].filter((url) => !isEmpty(url, true)));if (card.originUrls.length > 0) {card.url = card.originUrls[0];const blob = await fetch(card.url).then((res) => res.blob()).catch((err) => {return new Blob(undefined, {type: "none"});});if (/^image/.test(blob.type)) {const meta: metaInterFace = await getMetaByBlob(blob);if (meta.isOk) {card.name = getNameByUrl(card.url);card.meta.width = meta.width;card.meta.height = meta.height;card.meta.aspectRatio = meta.width / meta.height;card.match = true;}}}}if (card.match && !cardsStore.data.urlSet.has(card.url)) {const max =(filter.size.width.max =filter.size.height.max =Math.max(filter.size.width.max,filter.size.height.max,card.meta.width,card.meta.height));filter.size.width.value[1] = filter.size.height.value[1] = max;delete card.match; card["id"] = buildUUID(); tempCardList[index] = card;cardsStore.data.urlSet.add(card.url);cardsStore.data.domSet.add(card.dom);return ["符合条件（添加）", card.dom];} else {return ["不符合条件（排除）"];}};});taskQueue.singleCallback = () => {finallyCount++;loading.percentage = (finallyCount / cardDomList.length) * 100;};taskQueue.finallyCallback = () => {cardsStore.data.cardList.push(...tempCardList.filter((card) => card));ElMessage({message: "数据更新成功!",type: "success",showClose: true,grouping: true,offset: 80,});loading.percentage = 100;loading.reset();};taskQueue.run();};const getImgOrVideoDom = async () => {let imgDoms: any[] = [];if (filter.formats.value.length) {const formatList = filter.formats.value;for (const format of formatList) {imgDoms.push(...Array.from(document.querySelectorAll(`meta[property="og:image"][content $= '\.${format}']`)));imgDoms.push(...Array.from(document.querySelectorAll(`img[src $= '\.${format}']`)));imgDoms.push(...Array.from(document.querySelectorAll(`[href $= '\.${format}']`)));}} else {imgDoms.push(...Array.from(document.querySelectorAll(`meta[property="og:image"][content]`)));imgDoms.push(...Array.from(document.querySelectorAll(`img[src]`)));}return imgDoms;};defineExpose({getCards,});</script><style lang="scss" scoped>* {font-family: win-bug-omega, system-ui, -apple-system, "Segoe UI", Roboto,Ubuntu, Cantarell, "Noto Sans", "Hiragino Kaku Gothic ProN", Meiryo,sans-serif !important;}$my-font-family: win-bug-omega, system-ui, -apple-system, "Segoe UI", Roboto,Ubuntu, Cantarell, "Noto Sans", "Hiragino Kaku Gothic ProN", Meiryo,sans-serif;.onlineGallery-toolBar {& {position: relative;margin-top: 10px;margin-bottom: 10px;display: flex;flex-flow: row wrap;justify-content: start;align-items: center;gap: 14px;color: black;user-select: none;-webkit-user-drag: none;@media (max-width: 500px) {gap: 2px;margin-top: 4px;margin-bottom: 8px;padding-left: 20px;padding-right: 20px;}}.statistic {flex-shrink: 0;width: 120px;font-size: 16px !important;display: flex;flex-flow: column;justify-content: center;align-items: center;@media (max-width: 500px) {width: 100%;align-items: start;}}.filter {& {width: fit-content;display: flex;flex-flow: column;justify-content: center;align-items: center;@media (max-width: 500px) {width: 100%;align-items: start;gap: 2px;}}.size {& {flex-grow: 2;width: 250px;display: flex;flex-flow: column nowrap;@media (max-width: 500px) {gap: 2px;}}.row {display: flex;flex-flow: row nowrap;gap: 8px;justify-content: start;align-items: center;.slider {flex-grow: 1;}.label {margin: 0;white-space: nowrap; font-size: 16px !important;}}}.format {& {width: 250px;flex-grow: 1;display: flex;flex-flow: row;justify-content: center;align-items: center;gap: 8px;}.select {flex-grow: 1;}.label {margin: 0;text-align: center;white-space: nowrap; font-size: 16px !important;}}}.zoom-slider {width: 180px;font-size: 16px !important;@media (max-width: 500px) {width: 100%;}}.button-group {width: fit-content;}}</style>