<template> <div class="onlineGallery-toolBar"> <el-statistic class="statistic-container" :value="cardsStore.filterCards.length" :prefix="cardsStore.selectedCards.length.toString() + ' /'" :suffix="'/ ' + cardsStore.allValidCards.length.toString()" > <template #title> <div style="display: flex; justify-content: center">选中 / 可见 / 总数</div> </template> </el-statistic> <div class="filter-container"> <div class="filter-size"> <div class="width filter-size-row"> <span class="filter-size-label">宽度</span> <el-slider :debounce="1000" class="filter-size-slider" label="宽度" v-model="filter.size.width.value" range range-start-label="0" :min="0" :max="filter.size.max" :marks="filter.size.marks" placement="right" /> </div> <div class="height filter-size-row"> <span class="filter-size-label">高度</span> <el-slider :debounce="1000" class="filter-size-slider" label="高度" v-model="filter.size.height.value" range :min="0" :max="filter.size.max" :marks="filter.size.marks" placement="right" /> </div> </div> <SelectorFormat :options="filter.formats.options" :value="filter.formats.value" @update="(val) => (filter.formats.value = val)" /> </div> <div class="list-control-container"> <div class="list-control-column"> <span class="list-control-column-label">行数</span> <el-input-number class="list-control-column-input-number" :min="1" :max="4" :step="1" step-strictly controls-position="right" @wheel.passive="showColum_Wheel" v-model="toolbar.listControl.showColumn" ></el-input-number> </div> <div class="list-control-sort-method"> <span class="list-control-sort-method-label">排序</span> <el-select-v2 class="list-control-sort-method-select" v-model="listControl.sortMethod.value" :options="listControl.sortMethod.options" placeholder="排序方法" ></el-select-v2> </div> </div> <div class="rule-selector-container"> <span class="rule-selector-label">预设</span> <el-select-v2 class="rule-selector-select" v-model="ruleSelector.value" filterable :options="ruleSelector.option" placeholder="选择当前预设" > <template #empty> 11 </template> <template #default="node"> <div class="rule-item"> <el-image class="rule-icon" :src="node.item.iconUrl" > </el-image> {{ node.item.label }} </div> </template> </el-select-v2> </div> <el-button-group class="button-group-container"> <el-button type="primary" @click="refresh" :loading="loading.value" > 刷新 <template #icon> <el-icon><i-ep-RefreshRight /></el-icon> </template> </el-button> <el-button type="primary" @click="allSelectSwitch" :loading="loading.value" :icon="toolbar.listControl.allSelected ? CheckboxAll : CheckboxNone" > {{ toolbar.listControl.allSelected ? "取消全选" : "全部选中" }} </el-button> </el-button-group> <el-dropdown type="primary"> <el-button type="primary" @click="downloadSelected" :loading="loading.value" > 下载选中 <template #icon> <el-icon><i-ep-Download /></el-icon> </template> </el-button> <template #dropdown> <el-dropdown-menu> <el-dropdown-item @click="eagleStore.saveBoxContainer.open = true" >下载到Eagle</el-dropdown-item > </el-dropdown-menu> </template> </el-dropdown> <el-dropdown> <el-button type="primary"> <template #icon> <el-icon><i-ep-MoreFilled /></el-icon> </template> </el-button> <template #dropdown> <el-dropdown-menu> <el-dropdown-item @click="ruleEditor.container.open = true"> <el-icon><i-ep-Management /></el-icon> 规则管理 </el-dropdown-item> <el-dropdown-item @click=""> <el-icon><i-ep-Tools /></el-icon> 设置 </el-dropdown-item> </el-dropdown-menu> </template> </el-dropdown> </div></template><script setup lang="ts"> import {ITask} from "@/ts/public"; import CheckboxNone from "@/icon/checkbox-blank-line.svg?component"; import CheckboxAll from "@/icon/checkbox-fill.svg?component"; import BxCaretDown from "@/icon/bx-caret-down.svg?component"; import {title} from "process"; const appInfo = useAppInfoStore(); const cardsStore = useCardsStore(); const toolbar = useToolBarStore(); const ruleEditor = useRuleEditorStore(); const eagleStore = useEagleStore(); const loading = appInfo.loading; const filter = toolbar.filter; const listControl = toolbar.listControl; const ruleSelector = toolbar.ruleSelector; async function showColum_Wheel(e: WheelEvent) { if (e.deltaY < 0) { if (toolbar.listControl.showColumn < 4) toolbar.listControl.showColumn++; } else { if (toolbar.listControl.showColumn > 1) toolbar.listControl.showColumn--; } } async function refresh() { if (ruleSelector.value === "#") { await cardsStore.getCard(ruleEditor.defaultRule); } else { const ruleIndex = ruleEditor.data.ruleList.findIndex( (rule) => rule.id === ruleSelector.value ); const rule = ruleEditor.data.ruleList[ruleIndex]; if (rule) { await cardsStore.getCard(rule); } else { ElMessage({ message: "请选择预设后再尝试此操作", type: "info", showClose: true, grouping: true, offset: 120, }); } } } async function allSelectSwitch() { toolbar.listControl.allSelected = !toolbar.listControl.allSelected; appInfo.loading.value = true; cardsStore.filterCards.forEach((card) => (card.selected = toolbar.listControl.allSelected)); appInfo.loading.value = false; } async function downloadSelected() { const downloadCards = cardsStore.selectedCards; if (!downloadCards.length) { ElMessage({ message: "请选择要下载的数据", type: "info", showClose: true, grouping: true, offset: 120, }); return; } loading.init(); const taskQueue = new TaskQueue({showMessage: false, max: 5, delay: 100}); let zipContainer: JSZipType = new JSZip(); let finallyCount = 0; const taskList: ITask[] = downloadCards.map((card, index) => { return <ITask>{ index: index, main: async () => { const url = card.linkUrl; let blob: Blob | null = await getBlobByUrlAuto(url); if (blob) { let ext = ""; if (!isEmpty(card.linkUrlExt)) { ext = "." + card.linkUrlExt; } let fix = strAutofill(index.toString(), 0, 4); zipContainer.file(`${fix} - ${card.name}${ext}`, blob); return [card.name, "处理成功!"]; } else { return [card.name, "处理失败"]; } blob = null; }, callback: async (res, index) => { finallyCount++; loading.percentage = (finallyCount / downloadCards.length) * 100; }, }; }); taskQueue.pushTask(taskList); taskQueue.finallyCallback = async () => { ElMessage({ message: "下载成功! (正在生成压缩包)", type: "success", showClose: true, grouping: true, offset: 120, }); loading.init(); console.log("准备生成压缩包", zipContainer); let zip: Blob | null = await zipContainer.generateAsync( { type: "blob", compression: "DEFLATE", }, (metadata) => { loading.percentage = metadata.percent; } ); console.log("压缩包生成成功", zip); let zipName: string; let titles = [ document.title, ...[...document.querySelectorAll("h1")].map((dom) => dom.innerText), ...[...document.querySelectorAll("title")].map((dom) => dom.innerText), ] .filter((title) => !isEmpty(title)) .map((title) => title.replace("\\", "-").replace(",", "_")); if (titles.length) { zipName = titles[0]; } else { zipName = getNameByUrl(decodeURI(location.href)); } console.log("压缩包名称:", zipName); await saveAs(zip, `${zipName}.zip`); zip = null; loading.percentage = 100; loading.reset(); }; taskQueue.run(); }</script><style lang="scss" scoped> * { font-family: win-bug-omega, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif !important; } $my-font-family: win-bug-omega, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; .onlineGallery-toolBar { & { position: relative; margin-top: 10px; margin-bottom: 10px; display: flex; flex-flow: row wrap; justify-content: start; align-items: center; gap: 10px; user-select: none; -webkit-user-drag: none; @media (max-width: 500px) { gap: 4px; margin-top: 4px; margin-bottom: 8px; padding-left: 10px; padding-right: 10px; } } .statistic-container { flex-shrink: 0; width: 140px; font-size: 14px !important; display: flex; flex-flow: column; justify-content: center; align-items: center; @media (max-width: 500px) { width: 100%; align-items: start; } } .filter-container { & { width: fit-content; width: 220px; display: flex; flex-flow: column; justify-content: center; align-items: center; @media (max-width: 500px) { align-items: start; gap: 2px; } } .filter-size { & { position: relative; width: 100%; display: flex; flex-flow: column nowrap; justify-content: center; align-items: center; @media (max-width: 500px) { gap: 2px; } } .filter-size-row { width: 100%; display: flex; flex-flow: row nowrap; gap: 8px; justify-content: start; align-items: center; .filter-size-slider { flex-grow: 1; padding-right: 10px; } .filter-size-label { margin: 0; white-space: nowrap; font-size: 16px !important; color: black !important; } } } .filter-format { & { position: relative; width: 100%; display: flex; flex-flow: row; justify-content: center; align-items: center; gap: 8px; } .format-select { flex-grow: 1; } .format-label { margin: 0; text-align: center; white-space: nowrap; font-size: 16px !important; } } } .list-control-container { & { position: relative; width: fit-content; display: flex; flex-flow: column; justify-content: center; align-items: start; gap: 8px; @media (max-width: 500px) { flex-flow: row; } } .list-control-column { & { position: relative; width: fit-content; display: flex; flex-flow: row; justify-content: center; align-items: center; gap: 8px; } .list-control-column-input-number { width: 80px; } .list-control-column-label { margin: 0; text-align: center; white-space: nowrap; font-size: 16px !important; } } .list-control-sort-method { & { position: relative; width: fit-content; display: flex; flex-flow: row; justify-content: center; align-items: center; gap: 8px; } .list-control-sort-method-select { width: 120px; } .list-control-sort-method-label { margin: 0; text-align: center; white-space: nowrap; font-size: 16px !important; } } } .button-group-container { width: fit-content; } .rule-selector-container { & { position: relative; width: fit-content; display: flex; flex-flow: row; justify-content: center; align-items: center; gap: 8px; } .rule-selector-select { width: 160px; } .rule-selector-label { margin: 0; text-align: center; white-space: nowrap; font-size: 16px !important; } } } .rule-item { height: 100% !important; display: flex; justify-content: start; align-items: center; gap: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: black !important; } .rule-icon { flex-shrink: 0; width: 16px !important; aspect-ratio: 1; display: flex; justify-content: center; align-items: center; }</style>