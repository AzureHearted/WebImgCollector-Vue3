<template><el-dropdown-item :icon="Management" @click="info.open = true">规则管理器<teleport to=".onlineGallery-child-window-container" v-if="info.open"><div class="onlineGallery-RuleEditor-modal"><el-dialogstyle="pointer-events: auto !important; padding: 0px"v-model="info.open"width="60%":before-close="handleClose":modal="false":close-on-click-modal="false"top="10vh"draggable:lock-scroll="false"><template #header><span style="color: black; font-size: large">规则管理器</span></template><template #default><el-container style="user-select: none"><el-aside width="200px" show-checkbox highlight-current style="padding: 5px"><el-inputsize="small"v-model="info.tree.query"placeholder="输入关键词"@input="onQueryChanged" /><el-tree-v2ref="treeRef":data="treeData":props="treeProps":height="208"highlight-current:current-node-key="info.showRuleId":filter-method="treeFilterMethod"@node-click="treeNodeClick"><template #default="{node}"><div v-if="node.key != '#'" class="tree-item tree-item-normal"><span class="ruleName">{{ node.label }}</span><span class="icon-button-deleteRule"><HoverButton @click.stop="deleteRule(node.key, node)" /></span></div><div v-if="node.key == '#'" class="tree-item tree-item-add-button"><el-buttontype="primary"size="small":icon="CirclePlusFilled"@click="createRule">{{ node.label }}</el-button></div></template></el-tree-v2></el-aside><el-main style="padding: 5px"><RuleForm :formData="info.form.realTimeData" /></el-main></el-container></template><template #footer><el-button type="primary" @click="allSave">全部保存</el-button><el-button @click="handleClose">取消</el-button></template></el-dialog></div></teleport></el-dropdown-item></template><script setup>import HoverButton from "./HoverButton.vue";import RuleForm from "./RuleForm.vue";import {Rule, buildUUID} from "../js/public.js";import {Management, CirclePlusFilled} from "@element-plus/icons-vue"; const info = reactive({open: false,showRuleId: "#",form: {activeName: "main",realTimeData: null,},tree: {query: "", },});const data = reactive({ruleList: [],});const treeProps = reactive({value: "id",label: "label",children: "children",disabled: "disabled",});const inputFormData = async (ruleData = {}) => {if (ruleData.constructor === Rule) {if (!ruleData.status.editing && !ruleData.status.isNewCreated) {ruleData.createBackup(); ruleData.status.editing == true; }ruleData.status.isNewCreated = false; info.form.realTimeData = ruleData; info.showRuleId = ruleData.id; info.form.activeName = "main"; } else {info.form.realTimeData = null;info.showRuleId = "#"; }};const treeData = computed(() => {let result = data.ruleList.map((rule) => {return {id: rule.id,label: rule.main.name,children: [],disabled: false,isNew: rule.status.isNewCreated,};});result.push({id: "#",label: "创建规则",children: [],disabled: false,icon: CirclePlusFilled,});return result;});const treeRef = ref(null);const onQueryChanged = (query) => {treeRef.value.filter(query); };const treeFilterMethod = (query, node) => {return node.label.includes(query);};const treeNodeClick = (nodeData, node, e) => {console.log(node);const ruleIndex = data.ruleList.findIndex((item) => item.id === nodeData.id);if (ruleIndex >= 0) {inputFormData(data.ruleList[ruleIndex]);}};const createRule = async () => {let rule = new Rule(); data.ruleList.push(rule); inputFormData(rule);};const deleteRule = async (id, node) => {const index = data.ruleList.findIndex((item) => item.id === id);let rule = data.ruleList[index];const ruleName = rule.main.name;ElMessageBox.confirm(`确认删除规则 “${ruleName}” ？(此操作无法恢复)`, null, {confirmButtonText: "确认",cancelButtonText: "取消",lockScroll: false,}).then(() => {delete data.ruleList[index];data.ruleList.splice(index, 1);Rule.count--;inputFormData();ElMessage({type: "success",grouping: true,center: true,duration: 1000,offset: 80,message: `规则 “${ruleName}” 删除成功!`,});}).catch(() => {});};const handleClose = async () => {ElMessageBox.confirm("确认关闭？", null, {confirmButtonText: "确认",cancelButtonText: "取消",lockScroll: false,}).then(() => {info.open = false;initDialog();cleanData();}).catch(() => {});};const initDialog = async () => {info.form.activeName = "main";inputFormData();};const allSave = async () => {GM_setValue("ruleList", JSON.stringify(data.ruleList));info.open = false;cleanData();};const cleanData = async () => {for (let i = 0, len = data.ruleList.length; i < len; i++) {delete data.ruleList[i];Rule.count--;}data.ruleList = [];};watch(() => info.open,(newVal, oldVal) => {if (newVal) {initDialog();let localRuleList = GM_getValue("ruleList");if (localRuleList != null) {data.ruleList = JSON.parse(localRuleList).map((rawRule) => {return new Rule(rawRule); });console.log("数据已导入", data);} else {data.ruleList = [];console.log("本地数据为空 -> 初始化数据", data);}}});</script><style lang="scss">.onlineGallery-RuleEditor-modal {& {pointer-events: none !important;}.el-dialog__header {padding: 15px 10px 5px 20px;.el-dialog__headerbtn {top: 0;right: 0;width: 50px;height: 50px;}}.el-dialog__body {padding: 10px;min-height: 300px;.tree-item {& {width: 100%;display: flex;align-items: center;justify-content: space-between;padding-right: 10px;}&.tree-item-normal {> .icon-button-deleteRule {position: absolute;right: 12px;display: flex;justify-content: center;align-items: center;color: red;font-size: medium;}}&.tree-item-add-button {> button {width: 100%;}}}}.el-dialog__footer {padding: 10px;}}</style>