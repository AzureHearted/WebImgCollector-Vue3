<template><div class="onlineGallery-RuleEditor-modal"><el-dialogstyle="pointer-events: auto !important; padding: 0px"v-model="ruleEditor.container.open":width="appInfo.window.width > 800 ? '800px' : '100%'":before-close="handleClose":modal="false":close-on-click-modal="false":lock-scroll="false"destroy-on-closedraggable@open="handleOpen"@closed="handleClosed"><template #header><span style="color: black; font-size: large">规则管理器</span><span style="color: black; font-size: large">(共{{ ruleEditor.data.ruleList.length }}条规则)</span></template><template #default><el-container style="user-select: none"><el-asidewidth="200px"show-checkboxhighlight-currentstyle="padding: 5px"><el-inputclearablev-model="tree.query"placeholder="输入关键词"@input="onQueryChanged" /><el-tree-v2ref="treeRef":data="tree.treeData":props="tree.treeProps":height="400"highlight-current:current-node-key="info.showRuleId":filter-method="treeFilterMethod"@node-click="treeNodeClick":item-size="32"><template #default="{node}"><div v-if="node.key != '#'" class="tree-item tree-item-normal"><el-imagestyle="width: 24px; aspect-ratio: 1":src="node.data.iconUrl"></el-image><el-tooltip:show-after="500"effect="dark":content="node.label"placement="top"><span class="label-ruleName">{{ node.label }}</span></el-tooltip><span class="icon-button-deleteRule"><HoverButton@click.stop="deleteRule(node.key, node)"></HoverButton></span></div><divv-if="node.key == '#'"class="tree-item tree-item-add-button"><el-button type="primary" @click="createRule"><template #icon><el-icon><i-ep-CirclePlusFilled /></el-icon></template><span> {{ node.label }} </span></el-button></div></template></el-tree-v2></el-aside><el-main style="padding: 5px"><RuleForm :formData="form.realTimeData" /></el-main></el-container></template><template #footer><el-button type="info" @click="copyNowRule">复制当前规则</el-button><el-button type="primary" @click="allSave">全部保存</el-button><el-button @click="handleClose">取消</el-button></template></el-dialog></div></template><script setup lang="ts">import {MatchRule} from "@/ts/class/MatchRule";const {text, isSupported, copy} = useClipboard(); const appInfo = useAppInfoStore(); const ruleEditor = useRuleEditorStore(); const treeRef = ref();const info = ruleEditor.info;const form = ruleEditor.info.form;const tree = ruleEditor.info.tree;const data = ruleEditor.data;const inputFormData = async (ruleData?: MatchRule) => {if (ruleData != undefined) {if (!ruleData.status.editing && !ruleData.status.isNewCreated) {ruleData.createBackup(); ruleData.status.editing = true; }ruleData.status.isNewCreated = false; form.realTimeData = ruleData; info.showRuleId = ruleData.id; form.activeName = "main"; } else {form.realTimeData = undefined;info.showRuleId = "-1"; }};const onQueryChanged = (query: string) => {treeRef.value.filter(query); };const treeFilterMethod = (query: string, node: any): boolean => {return node.label.includes(query);};const treeNodeClick = (nodeData: any, node: any, e: MouseEvent) => {const ruleIndex = data.ruleList.findIndex((item) => item.id === nodeData.id);if (ruleIndex >= 0) {const rule = data.ruleList[ruleIndex];inputFormData(<any>rule);}};const createRule = async () => {const rule = await ruleEditor.createRule();inputFormData(rule);};const deleteRule = async (id: string, node: any) => {const ruleName = node.label;ElMessageBox.confirm(`确认删除规则 “${ruleName}” ？`, "提示", {confirmButtonText: "确认",cancelButtonText: "取消",lockScroll: false,}).then(() => {ruleEditor.deleteRule(id);inputFormData();ElMessage({type: "success",grouping: true,center: true,offset: 120,message: `规则 “${ruleName}” 删除成功!`,});}).catch(() => {});};const copyNowRule = async () => {const content = form.realTimeData?.getJsonData() as string;await copy(content);ElMessage({type: "success",grouping: true,center: true,duration: 1000,offset: 120,message: h("p", {style: "display:flex;gap:10px"}, [h("i", {style: "color: teal"}, "(规则)" + form.realTimeData?.main.name),h("span", {style: "color: black"}, "复制成功！"),]),});};const handleOpen = () => {initDialog();console.log("规则管理器 - Open");};const handleClose = async () => {ElMessageBox.confirm("确认关闭？", "提示", {confirmButtonText: "确认",cancelButtonText: "取消",lockScroll: false,}).then(() => {ruleEditor.container.open = false; }).catch(() => {});};const handleClosed = async () => {initDialog();console.log("规则管理器 - Close");};const initDialog = async () => {form.activeName = "main";inputFormData();};const allSave = async () => {await ruleEditor.saveRuleToLocation();ruleEditor.container.open = false; };</script><style lang="scss">.onlineGallery-RuleEditor-modal {& {pointer-events: none !important;}.el-dialog__header {padding: 15px 10px 5px 20px;.el-dialog__headerbtn {top: 0;right: 0;width: 50px;height: 50px;}}.el-dialog__body {padding: 10px;.el-container {position: relative;height: max-content;min-height: 300px;.el-tabs {height: 90%;}}.tree-item {& {display: flex;align-items: center;justify-content: space-between;overflow: hidden;}&.tree-item-normal {position: relative !important;flex-grow: 1;> .label-ruleName {flex-grow: 1;padding-left: 4px;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}> .icon-button-deleteRule {position: relative;right: 2px;width: 24px;height: auto;display: flex;justify-content: center;align-items: center;color: red;font-size: medium;}}&.tree-item-add-button {> button {width: 100%;}}}}.el-dialog__footer {padding: 10px;}}</style>