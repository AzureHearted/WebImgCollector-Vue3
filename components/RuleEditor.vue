<template> <div class="onlineGallery-RuleEditor-modal"> <el-dialog style="pointer-events: auto !important; padding: 0px" v-model="ruleEditor.container.open" :width="appInfo.window.width > 800 ? '800px' : '100%'" :before-close="handleClose" :modal="false" :close-on-click-modal="false" :lock-scroll="false" destroy-on-close draggable @open="handleOpen" @closed="handleClosed" > <template #header> <span style="color: black; font-size: large">规则管理器</span> <span style="color: black; font-size: large"> (共{{ ruleEditor.data.ruleList.length }}条规则) </span> </template> <template #default> <el-container style="user-select: none"> <el-aside width="200px" show-checkbox highlight-current style="padding: 5px" > <el-input clearable v-model="tree.query" placeholder="输入关键词" @input="onQueryChanged" /> <el-tree-v2 ref="treeRef" :data="tree.treeData" :props="tree.treeProps" :height="400" highlight-current :current-node-key="info.showRuleId" :filter-method="treeFilterMethod" @node-click="treeNodeClick" :item-size="32" > <template #default="{node}"> <div v-if="node.key != '#'" class="tree-item tree-item-normal" > <el-image style="width: 24px; aspect-ratio: 1" :src="node.data.iconUrl" ></el-image> <el-tooltip :show-after="500" effect="dark" :content="node.label" placement="top" > <span class="label-ruleName">{{ node.label }}</span> </el-tooltip> <span class="icon-button-deleteRule"> <HoverButton @click.stop="deleteRule(node.key, node)"></HoverButton> </span> </div> <div v-if="node.key == '#'" class="tree-item tree-item-add-button" > <el-button type="primary" @click="createRule" > <template #icon> <el-icon><i-ep-CirclePlusFilled /></el-icon> </template> <span> {{ node.label }} </span> </el-button> </div> </template> </el-tree-v2> </el-aside> <el-main style="padding: 5px"> <RuleForm :formData="(form.realTimeData as MatchRule)" /> </el-main> </el-container> </template> <template #footer> <el-button type="success" @click="pasteRule" > 粘贴规则 </el-button> <el-button type="" @click="copyNowRule" > 复制当前规则 </el-button> <el-button type="primary" @click="allSave" > 全部保存 </el-button> <el-button @click="handleClose">取消</el-button> </template> </el-dialog> </div></template><script setup lang="ts"> import {MatchRule} from "@/ts/class/MatchRule"; const {text, isSupported, copy} = useClipboard(); const appInfo = useAppInfoStore(); const ruleEditor = useRuleEditorStore(); const treeRef = ref(); const info = ruleEditor.info; const form = ruleEditor.info.form; const tree = ruleEditor.info.tree; const data = ruleEditor.data; async function inputFormData(ruleData?: MatchRule | null) { if (ruleData) { if (!ruleData.status.editing && !ruleData.status.isNewCreated) { ruleData.createBackup(); ruleData.status.editing = true; } ruleData.status.isNewCreated = false; form.realTimeData = ruleData; info.showRuleId = ruleData.id; form.activeName = "main"; } else { form.realTimeData = undefined; info.showRuleId = "-1"; } } function onQueryChanged(query: string) { treeRef.value.filter(query); } function treeFilterMethod(query: string, node: any): boolean { return node.label.includes(query); } function treeNodeClick(nodeData: any, node: any, e: MouseEvent) { const ruleIndex = data.ruleList.findIndex((item) => item.id === nodeData.id); if (ruleIndex >= 0) { const rule = data.ruleList[ruleIndex]; inputFormData(<any>rule); } } async function createRule() { const rule = await ruleEditor.createRule(); inputFormData(rule); } async function deleteRule(id: string, node: any) { const ruleName = node.label; ElMessageBox.confirm(`确认删除规则 “${ruleName}” ？`, "提示", { confirmButtonText: "确认", cancelButtonText: "取消", lockScroll: false, }) .then(() => { ruleEditor.deleteRule(id); inputFormData(); ElMessage({ type: "success", grouping: true, center: true, offset: 120, message: `规则 “${ruleName}” 删除成功!`, }); }) .catch(() => {}); } async function copyNowRule() { if (form.realTimeData) { const content = form.realTimeData.getJsonData() as string; await copy(content); ElMessage({ type: "success", grouping: true, center: true, duration: 1000, offset: 120, message: h("p", {style: "display:flex;gap:10px"}, [ h("i", {style: "color: teal"}, "(规则)" + form.realTimeData?.main.name), h("span", {style: "color: black"}, "复制成功！"), ]), }); } else { ElMessage({ type: "warning", grouping: true, center: true, duration: 1000, offset: 120, message: `请选择一个要复制的规则!`, }); } } async function pasteRule() { let text = await getClipBoardText(); let ruleObj: Object | null = null; try { ruleObj = JSON.parse(text); } catch (err) { } let rule: MatchRule | null = null; if (ruleObj) { rule = await ruleEditor.createRule(ruleObj); } if (!rule) { ElMessage({ type: "warning", grouping: true, center: true, offset: 120, message: `剪切板中没有合适的规则!`, }); }else{ ElMessage({ type: "success", grouping: true, center: true, offset: 120, message: `规则粘贴成功`, }); } } function handleOpen() { initDialog(); console.log("规则管理器 - Open"); } async function handleClose() { ElMessageBox.confirm("确认关闭？", "提示", { confirmButtonText: "确认", cancelButtonText: "取消", lockScroll: false, }) .then(() => { ruleEditor.container.open = false; }) .catch(() => {}); } async function handleClosed() { initDialog(); console.log("规则管理器 - Close"); } async function initDialog() { form.activeName = "main"; inputFormData(); } async function allSave() { await ruleEditor.saveRuleToLocation(); ruleEditor.container.open = false; }</script><style lang="scss"> .onlineGallery-RuleEditor-modal { & { pointer-events: none !important; } .el-dialog__header { padding: 15px 10px 5px 20px; .el-dialog__headerbtn { top: 0; right: 0; width: 50px; height: 50px; } } .el-dialog__body { padding: 10px; .el-container { position: relative; height: max-content; min-height: 300px; .el-tabs { height: 90%; } } .tree-item { & { display: flex; align-items: center; justify-content: space-between; overflow: hidden; } &.tree-item-normal { position: relative !important; flex-grow: 1; > .label-ruleName { flex-grow: 1; padding-left: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } > .icon-button-deleteRule { position: relative; right: 2px; width: 24px; height: auto; display: flex; justify-content: center; align-items: center; color: red; font-size: medium; } } &.tree-item-add-button { > button { width: 100%; } } } } .el-dialog__footer { padding: 10px; } }</style>