<template><divref="cardRef"class="onlineGallery-card":data-index="index":style="cardStyle":data-show="show":data-loading="loading"@contextmenu.prevent.self><atarget="_blank"class="card-FancyBox-anchor"data-onlineGallery-fancybox="onlineGallery":data-type="fancyBoxType":href="card.linkUrl":data-thumb="card.picUrl":data-width="fancyBoxWidth":data-height="fancyBoxHeight"></a><el-skeletonstyle="width: 100%; height: 100%; z-index: 0 !important":loading="loading || !show":throttle="500":animated="true":count="1"><template #template><el-skeleton-item variant="image" style="width: 100%; height: 100%" /></template><template #default><div class="really-content"><div class="onlineGallery-card-body" v-if="show"><Imgclass="content":src="card.picUrl":width="card.meta.width":height="card.meta.height":parentSelector="'#onlineGallery-list-container'":lazy="false"></Img></div><div class="onlineGallery-card-other" v-if="show"><transition name="bottom-top" appear><div class="tag-group" v-if="show"><el-tooltipeffect="dark":show-after="1000":enterable="false":content="card.linkUrlExt"placement="top"v-if="card.linkUrlExt"><el-tagclass="el-tag"hitroundsize="small"type="danger"@click.right="copyTagContent(card.linkUrlExt)">{{ card.linkUrlExt }}</el-tag></el-tooltip><el-tooltipv-if="card.linkSize"effect="dark":show-after="1000":enterable="false":content="linkSize_tag"placement="top"><el-tagclass="el-tag"roundhitsize="small"type="info"@click.right="copyTagContent(linkSize_tag)">{{ linkSize_tag }}</el-tag></el-tooltip><el-tooltipeffect="dark":show-after="1000":enterable="false":content="size_tag"placement="top"><el-tagclass="el-tag"size="small"type="info"hit@click.right="copyTagContent(size_tag)"round>{{ size_tag }}</el-tag></el-tooltip><el-tooltipeffect="dark":show-after="1000":enterable="false":content="card.name"placement="top"><el-tagclass="el-tag"hitroundsize="small"@click.right="copyTagContent(card.name)">{{ card.name }}</el-tag></el-tooltip></div></transition><transition name="top-bottom" appear><el-checkboxv-model="card.selected"class="checkbox"v-if="show" /></transition><transition name="top-bottom" appear><div class="button-group" v-if="show"><el-buttonclass="button download"type="primary"circle@click.stop="download":loading="downloading"><template #icon><el-icon><i-ep-Download /></el-icon></template></el-button><el-buttonclass="button toPosition"type="primary"circle@click.stop="toPosition":loading="downloading"><template #icon><el-icon><i-ep-LocationFilled /></el-icon></template></el-button></div></transition></div></div></template></el-skeleton></div></template><script setup lang="ts">const {text, isSupported, copy} = useClipboard(); interface Props {card: matchCard;index: number;}const props = withDefaults(defineProps<Props>(), {card: () => {return {name: "",linkUrl: "",picUrl: "",originUrls: [],metaOrigin: "",meta: <metaInterFace>{width: 0,height: 0,aspectRatio: 3 / 4,},selected: false, dom: null,visible: false,match: false,};},});const card = props.card;const appInfo = useAppInfoStore(); const loading = ref(true); const downloading = ref(false); const show = computed((): boolean => {return card.visible || visibility.value;});const cardStyle = computed(() => {return {"--aspect-ratio": card.meta.aspectRatio,};});type fancyBoxShowType = "image" | "iframe" | "video" | "inline" | "html";const fancyBoxType = computed((): fancyBoxShowType => {let type: fancyBoxShowType = "iframe";let linkUrlType = `${card.linkUrlType}`;if (card.linkUrlType !== "image" && card.linkUrlType !== "video") {linkUrlType = guessUrlType(card.linkUrl);}if (linkUrlType === "image" || linkUrlType === "video") {type = linkUrlType;} else {type = "iframe";}return type;});const fancyBoxWidth = computed((): number | null => {if ((fancyBoxType.value === "image" || fancyBoxType.value === "video") &&card.meta.width > 0) {return card.meta.width;} else {return null;}});const fancyBoxHeight = computed((): number | null => {if ((fancyBoxType.value === "image" || fancyBoxType.value === "video") &&card.meta.height > 0) {return card.meta.height;} else {return null;}});const size_tag = computed(() => {return `${card.meta.width}x${card.meta.height}`;});const linkSize_tag = computed(() => {if (card.linkSize) {return byteSizeAutoUnit(card.linkSize);} else {return (0).toFixed(2) + "KB";}});function byteSizeAutoUnit(byteSize: number, fixed: number = 2): string {enum Unit {"B" = 1,"KB","MB","GB","TB",}let unit = 1;let num = byteSize;while (num / 1024 >= 1) {if (unit + 1 >= 1 && unit <= 5) {num = num / 1024;unit++;} else {break;}}let unitStr: "B" | "KB" | "MB" | "GB" | "TB";switch (unit) {case 1:unitStr = "B";break;case 2:unitStr = "KB";break;case 3:unitStr = "MB";break;case 4:unitStr = "GB";break;case 4:unitStr = "GB";break;case 5:unitStr = "TB";break;default:num = byteSize;unitStr = "B";break;}return `${num.toFixed(fixed)}${unitStr}`;}const copyTagContent = async (content: string) => {await copy(content);ElMessage({type: "success",grouping: true,center: true,duration: 1000,offset: 120,message: h("p", {style: "display:flex;gap:10px"}, [h("i", {style: "color: teal"}, content),h("span", {style: "color: black"}, "复制成功！"),]),});};const download = async () => {const card = props.card;downloading.value = true;let blob: Blob | null = (await getBlobByUrlAuto(card.linkUrl)) as Blob;if (blob) {let ext = "";if (!isEmpty(card.linkUrlExt)) {ext = "." + card.linkUrlExt;}await saveAs(blob, `${card.name}${ext}`);blob = null;downloading.value = false;}};const toPosition = async () => {const dom = card.dom;if (dom != null) {appInfo.container.open = !appInfo.container.open;dom.scrollIntoView({behavior: "smooth",block: "center",inline: "center",});}};async function reNewLinkInfo() {let linkBlob: Blob | null = null;linkBlob = await getBlobByUrlAuto(card.linkUrl);card.linkSize = linkBlob?.size || 0;if (linkBlob) {card.linkUrlType = getBlobType(linkBlob);} else {card.linkUrlType = getUrlType(card.linkUrl);}if (linkBlob) card.linkUrlExt = getExtByBlob(linkBlob);linkBlob = null;}async function reNewPicInfo() {let picBlob: Blob | null = null;picBlob = await getBlobByUrlAuto(card.picUrl);card.picSize = picBlob?.size || 0;if (picBlob) {card.picUrlType = getBlobType(picBlob);} else {card.picUrlType = getUrlType(card.picUrl);}if (picBlob) card.picUrlExt = getExtByBlob(picBlob);picBlob = null;}const cardRef = ref<HTMLElement | null>();const visibility = useElementVisibility(cardRef, {scrollTarget: document.querySelector("#onlineGallery-list-container") as HTMLElement,});let stopFn: Function = () => {};onUpdated(() => {stopFn();const {stop} = useIntersectionObserver(cardRef,async ([{isIntersecting}], observerElement) => {card.visible = isIntersecting;},{immediate: true,root: document.querySelector("#onlineGallery-container") as HTMLElement,rootMargin: "100px 100px 100px 100px",});stopFn = stop;});onMounted(() => {reNewLoadingStatus();});onUpdated(() => {reNewLoadingStatus();});async function reNewLoadingStatus() {if (card.visible) {if (!card.linkUrlType) {console.log("信息获取");loading.value = true;await reNewLinkInfo();loading.value = false;} else {loading.value = false;}} else {loading.value = true;}}</script><style scoped lang="scss">* {border: 0;margin: 0;box-sizing: border-box;}.onlineGallery-card {border: 0 !important;margin: 0 !important;padding: 0 !important;scroll-snap-align: start;position: relative;border-radius: 4px;box-shadow: var(--el-box-shadow-dark);aspect-ratio: var(--aspect-ratio) !important;max-width: 100%;$height: max(var(--cardMaxHeight), 200px);max-height: $height;width: calc($height * var(--aspect-ratio)) !important;background-color: transparent;overflow: hidden;cursor: pointer;transition: 0.5s ease;&:hover {box-shadow: 1px 2px 12px 6px rgba(0, 0, 0, 0.5);}.card-FancyBox-anchor {position: absolute !important;width: 100%;height: 100%;z-index: 1;-webkit-user-drag: none;}.content {border: 0 !important;margin: 0 !important;padding: 0 !important;width: 100%;height: auto;object-position: center;-webkit-user-drag: none;background-position: center;background-repeat: repeat;background-size: contain;}.onlineGallery-card-other {.button-group {& {position: absolute;$padding: 4px;$margin: 4px;margin: $margin;top: 0;right: 0;width: 24px;height: 24px;border-radius: 12px;z-index: 1;}.button {position: absolute;margin: auto;padding: 0;left: 0;top: 0;right: 0;width: 100% !important;height: auto !important;aspect-ratio: 1 !important;font-size: medium;box-shadow: var(--el-box-shadow-light);}&:hover {& {height: 24px + 26px;}.button.download {transform: translateY(26px);transition: 0.25s;}}@media (max-width: 500px) {& {height: 24px + 26px !important;}.button.download {transform: translateY(26px) !important;transition: 0.25s;}}}.checkbox {position: absolute !important;height: fit-content;top: 4px !important;left: 4px !important;box-shadow: var(--el-box-shadow-light);z-index: 1;}.tag-group {position: absolute;width: 100% !important;bottom: 0px;left: 0px;padding: 4px;display: flex;flex-flow: row wrap;gap: 2px;z-index: 1;.el-tag {max-width: 100%;justify-content: start;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}}}}.v-enter-active,.v-leave-active {transition: 0.5s ease !important;}.v-enter-from,.v-leave-to {opacity: 0;}.top-bottom-enter-active,.top-bottom-leave-active {transition: 0.5s ease !important;}.top-bottom-enter-from,.top-bottom-leave-to {transform: translateY(-100%);}.bottom-top-enter-active,.bottom-top-leave-active {transition: 0.5s ease !important;}.bottom-top-enter-from,.bottom-top-leave-to {transform: translateY(100%);}.v-enter-active,.v-leave-active {transition: 0.5s ease !important;}.v-enter-from,.v-leave-to {opacity: 0;}</style>